<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量查询 - Story主网地址查询</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f4f7;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        .container {
            max-width: 1000px;
            margin: auto;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-family: monospace;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .result-item {
            background-color: #fff;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Story 主网批量查询</h1>
        <textarea id="addresses" placeholder="请输入地址，每行一个地址"></textarea>
        <button id="checkBalancesBtn">查询IP余额、交易次数、NFT 和其它代币</button>

        <table id="results">
            <thead>
                <tr>
                    <th>钱包地址</th>
                    <th>IP余额</th>
                    <th>交易次数</th>
                    <th>合约交互次数</th>
                    <th>NFT 名称和数量</th>
                    <th>其它代币</th>
                    <th>最后活跃时间</th>
                    <th>活跃天数</th>
                </tr>
            </thead>
            <tbody>
                <!-- 查询结果会在这里显示 -->
            </tbody>
        </table>

        <div class="footer">
            <p>由 <a href="https://x.com/0xXIAOc" target="_blank">@0xXIAOc</a> 提供</p>
        </div>
    </div>

    <script>
        document.getElementById("checkBalancesBtn").addEventListener("click", async function () {
            const addresses = document.getElementById("addresses").value.trim().split("\n");
            const resultsDiv = document.getElementById("results").getElementsByTagName('tbody')[0];
            resultsDiv.innerHTML = '';  // 清空之前的查询结果

            for (let address of addresses) {
                address = address.trim();
                if (!address) continue;

                try {
                    // 查询IP余额数据
                    const balanceResponse = await fetch(`https://www.storyscan.xyz/api/v2/addresses/${address}`);
                    const balanceData = await balanceResponse.json();

                    // 查询交易次数数据
                    const transactionResponse = await fetch(`https://www.storyscan.xyz/api/v2/addresses/${address}/tabs-counters`);
                    const transactionData = await transactionResponse.json();

                    // 查询NFT数据
                    const nftResponse = await fetch(`https://www.storyscan.xyz/api/v2/addresses/${address}/tokens?type=ERC-721`);
                    const nftData = await nftResponse.json();

                    // 查询其它代币数据
                    const tokensResponse = await fetch(`https://www.storyscan.xyz/api/v2/addresses/${address}/tokens?type=ERC-20`);
                    const tokensData = await tokensResponse.json();

                    // 查询交易记录用于获取最后活跃时间和活跃天数
                    const transactionsResponse = await fetch(`https://www.storyscan.xyz/api/v2/addresses/${address}/transactions`);
                    const transactionsData = await transactionsResponse.json();

                    // IP余额格式化
                    const balance = balanceData.coin_balance ? (parseInt(balanceData.coin_balance) / Math.pow(10, 18)).toFixed(6) : "N/A"; // 转换为标准的IP余额
                    const transactionsCount = transactionData.transactions_count || 0;
                    const internalTransactionsCount = transactionData.internal_transactions_count || 0;
                    const nftCount = nftData.items ? nftData.items.length : 0;

                    // NFT名称和数量
                    let nftList = '';
                    if (nftData.items && nftData.items.length > 0) {
                        nftList = nftData.items.map(item => `
                            <p><span>NFT 名称:</span> ${item.token.name}</p>
                            <p><span>NFT 数量:</span> ${item.value}</p>
                        `).join('');
                    } else {
                        nftList = `<p><span>NFT:</span> 没有NFT</p>`;
                    }

                    // 其它代币
                    let tokenList = '';
                    if (tokensData.items && tokensData.items.length > 0) {
                        tokenList = tokensData.items.map(item => {
                            let tokenBalance = parseInt(item.value) / Math.pow(10, item.token.decimals);
                            return `
                                <p><span>代币名称:</span> ${item.token.name} (${item.token.symbol})</p>
                                <p><span>余额:</span> ${tokenBalance.toFixed(6)} ${item.token.symbol}</p>
                            `;
                        }).join('');
                    } else {
                        tokenList = `<p><span>其它代币:</span> 无</p>`;
                    }

                    // 计算最后活跃时间
                    const lastActiveTimestamp = transactionsData.items[0]?.timestamp;
                    const lastActiveDate = lastActiveTimestamp ? new Date(lastActiveTimestamp) : null;
                    let lastActiveTime = '';
                    if (lastActiveDate) {
                        const today = new Date();
                        const diffInDays = Math.floor((today - lastActiveDate) / (1000 * 60 * 60 * 24));
                        if (diffInDays === 0) {
                            lastActiveTime = '今天';
                        } else if (diffInDays === 1) {
                            lastActiveTime = '1天前';
                        } else {
                            lastActiveTime = `${diffInDays}天前`;
                        }
                    }

                    // 计算活跃天数
                    const activeDates = new Set(transactionsData.items.map(tx => new Date(tx.timestamp).toLocaleDateString()));
                    const activeDaysCount = activeDates.size;

                    // 构造结果行
                    const resultHTML = `
                        <tr class="result-item">
                            <td>${address}</td>
                            <td>${balance} IP</td>
                            <td>${transactionsCount}</td>
                            <td>${internalTransactionsCount}</td>
                            <td>${nftList}</td>
                            <td>${tokenList}</td>
                            <td>${lastActiveTime}</td>
                            <td>${activeDaysCount}</td>
                        </tr>
                    `;
                    resultsDiv.innerHTML += resultHTML;
                } catch (error) {
                    console.error("Error fetching data for address:", address, error);
                    resultsDiv.innerHTML += `
                        <tr class="result-item">
                            <td colspan="8">查询失败: 无法获取数据</td>
                        </tr>
                    `;
                }
            }
        });
    </script>

</body>
</html>
